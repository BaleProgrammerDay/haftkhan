import React, { useState, useEffect, useRef } from 'react';
import styles from './BrainFixModal.module.scss';

interface BrainFixModalProps {
  isOpen: boolean;
  onClose: () => void;
  timeoutTriggeredAt?: string; // ISO string of when timeout was triggered
  timeoutAttemptHistory?: number; // Number of timeout attempts
}

// Original facts about Rostam and Rakhsh
const factsRostam = [
  "ููุช ุฎุงู ุฑุณุชู ฺฉ ุงุฒ ูุนุฑููโุชุฑู ุฏุงุณุชุงูโูุง ุดุงููุงูู ูุฑุฏูุณ ุงุณุช ฺฉู ุฏุฑ ุขู ุฑุณุชู ุจุฑุง ูุฌุงุช ฺฉฺฉุงููุณ ุจุงุฏ ุงุฒ ููุช ุฎุงู ุฎุทุฑูุงฺฉ ุนุจูุฑ ฺฉูุฏ.",
  "ุฑุฎุด ุงุณุจ ูุนุฑูู ุฑุณุชู ุจูุฏ ฺฉู ุฏุฑ ุชูุงู ุฌูฺฏโูุง ู ูุงุฌุฑุงูุงุด ููุฑุงู ุงู ุจูุฏ ู ุจู ุงู ุฏุฑ ูุจุฑุฏูุง ฺฉูฺฉ ูโฺฉุฑุฏ.",
  "ุฏุฑ ุฎุงู ุงููุ ุฑุณุชู ุจุง ุดุฑ ุฌูฺฏุฏ ู ุขู ุฑุง ุดฺฉุณุช ุฏุงุฏ. ุงู ุฎุงู ููุงุฏ ุบูุจู ุจุฑ ุชุฑุณ ู ุดุฌุงุนุช ุงุณุช.",
  "ุฎุงู ุฏูู ูุฑุจูุท ุจู ุฌูฺฏ ุจุง ุงฺุฏูุง ุจูุฏ ฺฉู ุฑุณุชู ุจุง ููุด ู ููุงุฑุช ุฎูุฏ ุขู ุฑุง ุดฺฉุณุช ุฏุงุฏ.",
  "ุฑุฎุด ูู ุชููุง ุงุณุจ ุฑุณุชู ุจูุฏุ ุจูฺฉู ุฏูุณุช ู ููุฑุงู ููุงุฏุงุฑุด ูุญุณูุจ ูโุดุฏ ู ุฏุฑ ูุญุธุงุช ุณุฎุช ฺฉูุงุฑุด ุจูุฏ.",
  "ุฏุฑ ุฎุงู ุณููุ ุฑุณุชู ุจุง ุฌุงุฏูฺฏุฑ ุฌูฺฏุฏ ู ุจุง ุงุณุชูุงุฏู ุงุฒ ุฎุฑุฏ ุฎูุฏ ุจุฑ ุงู ูพุฑูุฒ ุดุฏ.",
  "ููุช ุฎุงู ุฑุณุชู ููุงุฏ ููุช ูุฑุญูู ุฑุดุฏ ู ุชฺฉุงูู ุฑูุญ ู ุฌุณู ุงูุณุงู ุงุณุช.",
  "ุฑุฎุด ุฏุฑ ุฒุจุงู ูุงุฑุณ ุจู ูุนูุง 'ุฏุฑุฎุดูุฏู' ู 'ููุฑุงู' ุงุณุช ฺฉู ูุดุงูโุฏููุฏู ูพุงฺฉ ู ููุฑุงูุช ุงุณุช.",
  "ุฏุฑ ุฎุงู ฺูุงุฑูุ ุฑุณุชู ุจุง ุฏู ุฌูฺฏุฏ ู ุจุง ุดุฌุงุนุช ู ููุงุฑุช ุฎูุฏ ุขู ุฑุง ุดฺฉุณุช ุฏุงุฏ.",
  "ูุฑุฏูุณ ุฏุฑ ุดุงููุงููุ ุฑุฎุด ุฑุง ุจู ุนููุงู ุงุณุจ ุชูุตู ฺฉุฑุฏู ฺฉู ุณุฑุนุช ู ูุฏุฑุช ูููโุงูุนุงุฏูโุง ุฏุงุดุช.",
  "ุฎุงู ูพูุฌู ูุฑุจูุท ุจู ุฌูฺฏ ุจุง ุงฺุฏูุง ุขุชุดู ุจูุฏ ฺฉู ุฑุณุชู ุจุง ุตุจุฑ ู ุญูุตูู ุขู ุฑุง ุดฺฉุณุช ุฏุงุฏ.",
  "ุฑุฎุด ุฏุฑ ุชูุงู ูุงุฌุฑุงูุง ุฑุณุชู ุญุถูุฑ ุฏุงุดุช ู ูุฑฺฏุฒ ุงู ุฑุง ุชููุง ูฺฏุฐุงุดุช.",
  "ุฏุฑ ุฎุงู ุดุดูุ ุฑุณุชู ุจุง ุฌุงุฏูฺฏุฑ ุจุฒุฑฺฏ ุฌูฺฏุฏ ู ุจุง ุงุณุชูุงุฏู ุงุฒ ุฎุฑุฏ ู ุดุฌุงุนุช ุฎูุฏ ุจุฑ ุงู ูพุฑูุฒ ุดุฏ.",
  "ููุช ุฎุงู ุฑุณุชู ฺฉ ุงุฒ ูููโุชุฑู ุจุฎุดโูุง ุงุฏุจุงุช ูุงุฑุณ ุงุณุช ฺฉู ุฏุฑุณโูุง ุงุฎูุงู ุฒุงุฏ ุฏุงุฑุฏ.",
  "ุฑุฎุด ููุงุฏ ููุงุฏุงุฑุ ุฏูุณุช ู ููุฑุงู ุฏุฑ ุงุฏุจุงุช ูุงุฑุณ ุงุณุช.",
  "ุฏุฑ ุฎุงู ููุชู ู ุขุฎุฑุ ุฑุณุชู ุจุง ุจุฒุฑฺฏโุชุฑู ุฏุดูู ุฎูุฏ ุฌูฺฏุฏ ู ุจุง ุดุฌุงุนุช ู ููุงุฑุช ุฎูุฏ ูพุฑูุฒ ุดุฏ.",
  "ูุฑุฏูุณ ุฏุฑ ุดุงููุงูู ุชุฃฺฉุฏ ฺฉุฑุฏู ฺฉู ุฑุฎุด ูู ุชููุง ุงุณุจ ุฑุณุชู ุจูุฏุ ุจูฺฉู ุฏูุณุช ู ููุฑุงู ุงู ูุญุณูุจ ูโุดุฏ.",
  "ููุช ุฎุงู ุฑุณุชู ูุดุงูโุฏููุฏู ุงู ุงุณุช ฺฉู ุจุฑุง ุฑุณุฏู ุจู ูุฏูุ ุจุงุฏ ุงุฒ ููุงูุน ู ูุดฺฉูุงุช ุนุจูุฑ ฺฉุฑุฏ.",
  "ุฑุฎุด ุฏุฑ ุชูุงู ุฌูฺฏโูุง ู ูุงุฌุฑุงูุง ุฑุณุชู ุญุถูุฑ ุฏุงุดุช ู ุจู ุงู ุฏุฑ ูุจุฑุฏูุง ฺฉูฺฉ ูโฺฉุฑุฏ.",
  "ูุฑุฏูุณ ุฏุฑ ุดุงููุงููุ ุฑุฎุด ุฑุง ุจู ุนููุงู ุงุณุจ ุชูุตู ฺฉุฑุฏู ฺฉู ุณุฑุนุช ู ูุฏุฑุช ูููโุงูุนุงุฏูโุง ุฏุงุดุช."
];

// Alternative facts about Persian mythology and heroes
const factsMythology = [
  "ฺฉุงูู ุขููฺฏุฑ ุจุง ุฏุฑูุด ฺฉุงูุงู ุฎูุฏ ุนูู ุถุญุงฺฉ ูุงู ฺฉุฑุฏ ู ูุฑุฏู ุฑุง ุจู ุขุฒุงุฏ ุฏุนูุช ฺฉุฑุฏ.",
  "ุณูุฑุบ ูพุฑูุฏู ุงูุณุงููโุง ุงุฑุงู ุงุณุช ฺฉู ุฏุฑ ุดุงููุงูู ุจู ุนููุงู ูพุฑูุฏูโุง ุฎุฑุฏููุฏ ู ูุฏุฑุชููุฏ ุชูุตู ุดุฏู.",
  "ุฒุงู ูพุฏุฑ ุฑุณุชู ุจูุฏ ฺฉู ุชูุณุท ุณูุฑุบ ุจุฒุฑฺฏ ุดุฏ ู ุจุนุฏูุง ูพุฏุฑ ุฑุณุชู ุดุฏ.",
  "ฺฉฺฉุงููุณ ูพุงุฏุดุงู ุงุฑุงู ุจูุฏ ฺฉู ุชูุณุท ุฏููุง ุงุณุฑ ุดุฏ ู ุฑุณุชู ุจุฑุง ูุฌุงุชุด ุจู ููุช ุฎุงู ุฑูุช.",
  "ุณูุฑุงุจ ูพุณุฑ ุฑุณุชู ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏ ุจุง ูพุฏุฑุด ฺฉุดุชู ุดุฏ ู ุงู ฺฉ ุงุฒ ุบูฺฏูโุชุฑู ุฏุงุณุชุงูโูุง ุดุงููุงูู ุงุณุช.",
  "ุชูููู ููุณุฑ ุฑุณุชู ู ูุงุฏุฑ ุณูุฑุงุจ ุจูุฏ ฺฉู ุฏุฑ ุชูุฑุงู ุฒูุฏฺฏ ูโฺฉุฑุฏ.",
  "ุงูุฑุงุณุงุจ ูพุงุฏุดุงู ุชูุฑุงู ู ุฏุดูู ุงุตู ุงุฑุงู ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏโูุง ูุชุนุฏุฏ ุจุง ุงุฑุงูุงู ุฌูฺฏุฏ.",
  "ฺฏูุฏุฑุฒ ฺฉ ุงุฒ ูพูููุงูุงู ุจุฒุฑฺฏ ุงุฑุงู ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏโูุง ูุชุนุฏุฏ ุดุฑฺฉุช ุฏุงุดุช.",
  "ุจฺู ูพุณุฑ ฺฏูุฏุฑุฒ ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏ ุจุง ุงูุฑุงุณุงุจ ฺฉุดุชู ุดุฏ.",
  "ฺฏู ูพุฏุฑ ุจฺู ู ฺฉ ุงุฒ ูพูููุงูุงู ุจุฒุฑฺฏ ุงุฑุงู ุจูุฏ.",
  "ุทูุณ ฺฉ ุงุฒ ูพูููุงูุงู ุงุฑุงู ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏโูุง ูุชุนุฏุฏ ุดุฑฺฉุช ุฏุงุดุช.",
  "ูุฑุงูุฑุฒ ูพุณุฑ ุฑุณุชู ุจูุฏ ฺฉู ุจุนุฏ ุงุฒ ูุฑฺฏ ูพุฏุฑุด ุจู ุงูุชูุงู ุงู ุจุฑุฎุงุณุช.",
  "ุงุณููุฏุงุฑ ูพุณุฑ ฺฏุดุชุงุณุจ ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏ ุจุง ุฑุณุชู ฺฉุดุชู ุดุฏ.",
  "ฺฏุดุชุงุณุจ ูพุงุฏุดุงู ุงุฑุงู ุจูุฏ ฺฉู ุฏุฑ ุฒูุงู ุฑุณุชู ุญฺฉููุช ูโฺฉุฑุฏ.",
  "ุฒุฑุฑ ุจุฑุงุฏุฑ ฺฏุดุชุงุณุจ ุจูุฏ ฺฉู ุฏุฑ ุฌูฺฏ ุจุง ุงูุฑุงุณุงุจ ฺฉุดุชู ุดุฏ.",
  "ููู ุฎุฏุง ฺฏุงู ููุฏุณ ุงุฑุงูุงู ุจูุฏ ฺฉู ุฏุฑ ูุฑุงุณู ูุฐูุจ ุงุณุชูุงุฏู ูโุดุฏ.",
  "ุขูุงูุชุง ุงููู ุขุจ ู ุจุงุฑูุฑ ุฏุฑ ุขู ุฒุฑุชุดุช ุจูุฏ.",
  "ููุฑ ุฎุฏุง ุนูุฏ ู ูพูุงู ุฏุฑ ุขู ุฒุฑุชุดุช ุจูุฏ.",
  "ุงููุฑุงูุฒุฏุง ุฎุฏุง ุจุฒุฑฺฏ ุฒุฑุชุดุชุงู ุจูุฏ ฺฉู ุฎุงูู ููู ฺุฒ ูุญุณูุจ ูโุดุฏ.",
  "ุงูุฑูู ูุฑู ุดุฑ ุฏุฑ ุขู ุฒุฑุชุดุช ุจูุฏ ฺฉู ุจุง ุงููุฑุงูุฒุฏุง ุฏุฑ ุฌูฺฏ ุจูุฏ."
];

// Alternative facts about Persian culture and history
const factsCulture = [
  "ููุฑูุฒ ูููโุชุฑู ุฌุดู ุงุฑุงูุงู ุงุณุช ฺฉู ุฏุฑ ุงูู ุจูุงุฑ ุจุฑฺฏุฒุงุฑ ูโุดูุฏ ู ููุงุฏ ุชุฌุฏุฏ ุญุงุช ุงุณุช.",
  "ุณูุฑู ููุชโุณู ฺฉ ุงุฒ ุณูุชโูุง ููุฑูุฒ ุงุณุช ฺฉู ููุช ฺุฒ ฺฉู ุจุง 'ุณ' ุดุฑูุน ูโุดูุฏ ุฑู ุขู ูุฑุงุฑ ูโฺฏุฑุฏ.",
  "ฺูุงุฑุดูุจูโุณูุฑ ุขุฎุฑู ฺูุงุฑุดูุจู ุณุงู ุงุณุช ฺฉู ูุฑุฏู ุขุชุด ุฑูุดู ูโฺฉููุฏ ู ุงุฒ ุฑู ุขู ูโูพุฑูุฏ.",
  "ุนุฏ ูุทุฑ ุฌุดู ูพุงุงู ูุงู ุฑูุถุงู ุงุณุช ฺฉู ูุณููุงูุงู ุขู ุฑุง ุฌุดู ูโฺฏุฑูุฏ.",
  "ุนุฏ ูุฑุจุงู ุฌุดู ูุฑุจุงู ฺฉุฑุฏู ุงุณุช ฺฉู ุฏุฑ ุขู ฺฏูุณููุฏ ูุฑุจุงู ูโุดูุฏ.",
  "ุดุจ ูุฏุง ุทููุงูโุชุฑู ุดุจ ุณุงู ุงุณุช ฺฉู ุฎุงููุงุฏูโูุง ุฏูุฑ ูู ุฌูุน ูโุดููุฏ.",
  "ูุงู ูุญุฑู ูุงู ุนุฒุงุฏุงุฑ ุดุนุงู ุงุณุช ฺฉู ุฏุฑ ุขู ูุฑุงุณู ุนุงุดูุฑุง ุจุฑฺฏุฒุงุฑ ูโุดูุฏ.",
  "ุชุงุณูุนุง ู ุนุงุดูุฑุง ุฑูุฒูุง ููู ุนุฒุงุฏุงุฑ ุดุนุงู ูุณุชูุฏ.",
  "ูุงู ุฑูุถุงู ูุงู ุฑูุฒูโฺฏุฑ ูุณููุงูุงู ุงุณุช ฺฉู ุฏุฑ ุขู ุงุฒ ุทููุน ุชุง ุบุฑูุจ ุฎูุฑุดุฏ ุฑูุฒู ูโฺฏุฑูุฏ.",
  "ุญุฌ ฺฉ ุงุฒ ุงุฑฺฉุงู ุงุณูุงู ุงุณุช ฺฉู ูุณููุงูุงู ุจุงุฏ ุญุฏุงูู ฺฉ ุจุงุฑ ุฏุฑ ุนูุฑ ุฎูุฏ ุงูุฌุงู ุฏููุฏ.",
  "ุฒฺฉุงุช ฺฉ ุงุฒ ุงุฑฺฉุงู ุงุณูุงู ุงุณุช ฺฉู ูุณููุงูุงู ุจุงุฏ ุจุฎุด ุงุฒ ุงููุงู ุฎูุฏ ุฑุง ุจู ููุฑุง ุจุฏููุฏ.",
  "ููุงุฒ ฺฉ ุงุฒ ุงุฑฺฉุงู ุงุณูุงู ุงุณุช ฺฉู ูุณููุงูุงู ุจุงุฏ ูพูุฌ ุจุงุฑ ุฏุฑ ุฑูุฒ ุงูุฌุงู ุฏููุฏ.",
  "ุดูุงุฏุชู ุฏู ุฌูููโุง ุงุณุช ฺฉู ูุณููุงู ุดุฏู ุจุง ฺฏูุชู ุขู ุขุบุงุฒ ูโุดูุฏ.",
  "ูุฑุขู ฺฉุชุงุจ ููุฏุณ ูุณููุงูุงู ุงุณุช ฺฉู ฺฉูุงู ุฎุฏุง ูุญุณูุจ ูโุดูุฏ.",
  "ุญุฏุซ ุณุฎูุงู ูพุงูุจุฑ ุงุณูุงู ุงุณุช ฺฉู ุชูุณุท ุตุญุงุจู ููู ุดุฏู ุงุณุช.",
  "ุณูุช ุฑูุด ู ุฑูุชุงุฑ ูพุงูุจุฑ ุงุณูุงู ุงุณุช ฺฉู ูุณููุงูุงู ุจุงุฏ ุงุฒ ุขู ูพุฑู ฺฉููุฏ.",
  "ููู ุนูู ุงุณุชูุจุงุท ุงุญฺฉุงู ุดุฑุน ุงุฒ ููุงุจุน ุงุณูุงู ุงุณุช.",
  "ุชูุณุฑ ุนูู ุชูุณุฑ ูุฑุขู ุงุณุช ฺฉู ูุนุงู ุขุงุช ุฑุง ุชูุถุญ ูโุฏูุฏ.",
  "ุชุงุฑุฎ ุงุณูุงู ุชุงุฑุฎ ุฒูุฏฺฏ ูพุงูุจุฑ ู ุฎููุง ุฑุงุดุฏู ุงุณุช.",
  "ุณุฑู ูพุงูุจุฑ ุฑูุด ุฒูุฏฺฏ ู ุฑูุชุงุฑ ูพุงูุจุฑ ุงุณูุงู ุงุณุช."
];

// Alternative facts about Persian literature and poetry
const factsLiterature = [
  "ูุฑุฏูุณ ุดุงุนุฑ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุดุงููุงูู ุฑุง ุฏุฑ ูุฏุช ณฐ ุณุงู ุณุฑูุฏ.",
  "ุดุงููุงูู ูุฑุฏูุณ ุดุงูู ถฐ ูุฒุงุฑ ุจุช ุดุนุฑ ุงุณุช ู ฺฉ ุงุฒ ุจุฒุฑฺฏโุชุฑู ุขุซุงุฑ ุงุฏุจ ุฌูุงู ูุญุณูุจ ูโุดูุฏ.",
  "ุญุงูุธ ุดุงุนุฑ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฏูุงูุด ฺฉ ุงุฒ ูุญุจูุจโุชุฑู ฺฉุชุงุจโูุง ุดุนุฑ ูุงุฑุณ ุงุณุช.",
  "ุณุนุฏ ุดุงุนุฑ ู ููุณูุฏู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ฺฏูุณุชุงู ู ุจูุณุชุงู ุฑุง ููุดุชู ุงุณุช.",
  "ูููู ุดุงุนุฑ ู ุนุงุฑู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ูุซูู ูุนูู ุฑุง ุณุฑูุฏ.",
  "ุนุทุงุฑ ุดุงุนุฑ ู ุนุงุฑู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ููุทูโุงูุทุฑ ุฑุง ููุดุชู ุงุณุช.",
  "ูุธุงู ุดุงุนุฑ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฎูุณู ุฑุง ุณุฑูุฏ.",
  "ุฎุงูุงู ุดุงุนุฑ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ูุตุงุฏ ุฒุจุง ุณุฑูุฏู ุงุณุช.",
  "ุงููุฑ ุดุงุนุฑ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ูุตุงุฏ ู ุบุฒูุงุช ุฒุจุง ุฏุงุฑุฏ.",
  "ุฑูุฏฺฉ ูพุฏุฑ ุดุนุฑ ูุงุฑุณ ุงุณุช ฺฉู ุงููู ุดุงุนุฑ ุจุฒุฑฺฏ ูุงุฑุณโุฒุจุงู ูุญุณูุจ ูโุดูุฏ.",
  "ูุงุฑุงุจ ููุณูู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฏุฑ ููุณูู ู ููุทู ุชุฃุซุฑ ุฒุงุฏ ุฏุงุดุชู ุงุณุช.",
  "ุงุจู ุณูุง ูพุฒุดฺฉ ู ููุณูู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ูุงููู ุฏุฑ ุทุจ ุฑุง ููุดุชู ุงุณุช.",
  "ุฎูุงุฑุฒู ุฑุงุถุฏุงู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฌุจุฑ ุฑุง ุงุฎุชุฑุงุน ฺฉุฑุฏู ุงุณุช.",
  "ุฑุงุฒ ุดูโุฏุงู ู ูพุฒุดฺฉ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฏุฑ ุนูู ุดู ุชุฃุซุฑ ุฒุงุฏ ุฏุงุดุชู ุงุณุช.",
  "ุจุฑูู ุฏุงูุดููุฏ ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฏุฑ ูุฌูู ู ุฌุบุฑุงูุง ุชุฃุซุฑ ุฒุงุฏ ุฏุงุดุชู ุงุณุช.",
  "ุฎุงู ุดุงุนุฑ ู ุฑุงุถุฏุงู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุฑุจุงุนุงุช ุฒุจุง ุณุฑูุฏู ุงุณุช.",
  "ูุงุตุฑุฎุณุฑู ุดุงุนุฑ ู ููุณูู ุจุฒุฑฺฏ ุงุฑุงู ุงุณุช ฺฉู ุณูุฑูุงููโุง ุฒุจุง ููุดุชู ุงุณุช.",
  "ุนูุฑ ุฎุงู ุนูุงูู ุจุฑ ุดุนุฑุ ุฏุฑ ุฑุงุถุงุช ู ูุฌูู ูุฒ ุชุฃุซุฑ ุฒุงุฏ ุฏุงุดุชู ุงุณุช.",
  "ุงุจูุฑุญุงู ุจุฑูู ุฏุฑ ฺฉุชุงุจ ุขุซุงุฑ ุงูุจุงูู ุฏุฑุจุงุฑู ุชุงุฑุฎ ู ูุฑููฺฏ ููู ูุฎุชูู ููุดุชู ุงุณุช.",
  "ุงุจูุนู ุณูุง ุฏุฑ ฺฉุชุงุจ ุดูุง ุฏุฑุจุงุฑู ููุณูู ู ููุทู ูุทุงูุจ ููู ููุดุชู ุงุณุช."
];

export const BrainFixModal: React.FC<BrainFixModalProps> = ({ isOpen, onClose, timeoutTriggeredAt, timeoutAttemptHistory = 0 }) => {
  const [timeLeft, setTimeLeft] = useState(120); // 2 minutes in seconds
  const [currentFactIndex, setCurrentFactIndex] = useState(0);
  const [audioEnabled, setAudioEnabled] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // Select facts based on timeoutAttemptHistory % 4
  const getFacts = () => {
    const factSetIndex = timeoutAttemptHistory % 4;
    switch (factSetIndex) {
      case 0:
        return factsRostam;
      case 1:
        return factsMythology;
      case 2:
        return factsCulture;
      case 3:
        return factsLiterature;
      default:
        return factsRostam;
    }
  };

  const facts = getFacts();

  useEffect(() => {
    if (!isOpen) return;

    // Play background music when modal opens
    const playBackgroundMusic = () => {
      if (!audioRef.current) {
        audioRef.current = new Audio('https://load.filespacer.ir/music/B/Bikalam.Aroom/Loreena.McKennitt.Tango.To.Evora.%5Bsongha.ir%5D.mp3');
        audioRef.current.loop = true;
        audioRef.current.volume = 0.3; // Set volume to 30%
      }
      
      if (audioEnabled) {
        audioRef.current.play().catch((error) => {
          console.log('Audio playback failed:', error);
        });
      }
    };

    // Calculate remaining time based on when timeout was triggered
    const calculateRemainingTime = () => {
      if (timeoutTriggeredAt) {
        const triggeredTime = new Date(timeoutTriggeredAt).getTime();
        const currentTime = new Date().getTime();
        const elapsedSeconds = Math.floor((currentTime - triggeredTime) / 1000);
        const remaining = Math.max(0, 120 - elapsedSeconds);
        return remaining;
      }
      return 120; // Default 2 minutes if no timeout time provided
    };

    const initialTimeLeft = calculateRemainingTime();
    setTimeLeft(initialTimeLeft);
    setCurrentFactIndex(0);

    // Play background music
    playBackgroundMusic();

    // If time is already up, close immediately
    if (initialTimeLeft <= 0) {
      onClose();
      return;
    }

    // Timer countdown
    const timer = setInterval(() => {
      setTimeLeft((prev) => {
        if (prev <= 1) {
          clearInterval(timer);
          onClose();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    // Change fact every 6 seconds
    const factTimer = setInterval(() => {
      setCurrentFactIndex((prev) => (prev + 1) % facts.length);
    }, 6000);

    return () => {
      clearInterval(timer);
      clearInterval(factTimer);
      // Stop audio when modal closes
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
      }
    };
  }, [isOpen, onClose, timeoutTriggeredAt, audioEnabled]);

  // Function to enable audio playback
  const enableAudio = () => {
    setAudioEnabled(true);
    if (audioRef.current && isOpen) {
      audioRef.current.play().catch((error) => {
        console.log('Audio playback failed:', error);
      });
    }
  };

  // Cleanup audio on component unmount
  useEffect(() => {
    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
      }
    };
  }, []);

  if (!isOpen) return null;

  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  const progress = ((120 - timeLeft) / 120) * 100;

  return (
    <div className={styles.overlay}>
      <div className={styles.modal}>
        <div className={styles.header}>
          <h2 className={styles.title}>ูุบุฒูู ุณูุฒููุฏ ุญุงูุง ุจุงุฏ ฒ ุฏููู ูุงุณ ุชุง ูุบุฒูู ุฏุฑุณุช ฺฉูู</h2>
          {!audioEnabled && (
            <button 
              className={styles.playButton}
              onClick={enableAudio}
            >
              ๐ต ูพุฎุด ููุณู
            </button>
          )}
        </div>
        
        <div className={styles.content}>
          <div className={styles.timerSection}>
            <div className={styles.timer}>
              <div className={styles.timeDisplay}>
                {minutes.toString().padStart(2, '0')}:{seconds.toString().padStart(2, '0')}
              </div>
              <div className={styles.progressBar}>
                <div 
                  className={styles.progressFill} 
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>
          </div>

          <div className={styles.factsSection}>
            <h3 className={styles.factsTitle}>ุขุง ูโุฏุงูุณุชุฏุ</h3>
            <div className={styles.factContainer}>
              <p className={styles.factText}>{facts[currentFactIndex]}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
